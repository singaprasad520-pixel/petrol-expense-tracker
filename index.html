
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FuelTracker Pro - Fixed Version</title>
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,600,700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<meta name="theme-color" content="#FFD600">
<style>
  :root {
    --primary-yellow: #FFD600;
    --primary-yellow-light: #FFF9E2;
    --dark-text: #1a1a1a;
    --medium-text: #4a4a4a;
    --light-text: #7a7a7a;
    --background-gray: #f8fafc;
    --card-white: #ffffff;
    --border-light: #e2e8f0;
    --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.05);
    --shadow-medium: 0 8px 25px rgba(0, 0, 0, 0.1);
    --gradient-yellow: linear-gradient(135deg, #FFD600 0%, #FFA000 100%);
    --success-green: #10b981;
    --info-blue: #3b82f6;
    --error-red: #ef4444;
    --warning-orange: #f59e0b;
    --border-radius-sm: 8px;
    --border-radius-md: 12px;
    --border-radius-lg: 16px;
    --transition-smooth: all 0.3s ease;
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    background: var(--background-gray);
    font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    color: var(--dark-text);
    font-size: 14px;
    line-height: 1.6;
  }

  /* NAVIGATION - MOBILE FRIENDLY */
  .navbar {
    display: flex;
    align-items: center;
    background: var(--card-white);
    padding: 0 20px;
    box-shadow: var(--shadow-soft);
    position: sticky;
    top: 0;
    z-index: 1000;
    min-height: 64px;
    flex-wrap: wrap;
  }

  .nav-logo {
    font-weight: 700;
    background: var(--gradient-yellow);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-size: 1.8rem;
    margin-right: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .nav-menu {
    display: flex;
    gap: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .nav-menu::-webkit-scrollbar { display: none; }

  .nav-menu span {
    cursor: pointer;
    padding: 8px 12px;
    border-radius: var(--border-radius-sm);
    transition: var(--transition-smooth);
    color: var(--medium-text);
    white-space: nowrap;
  }

  .nav-menu span:hover {
    background: var(--primary-yellow-light);
    color: var(--primary-yellow);
  }

  .nav-menu .active {
    color: var(--primary-yellow);
    background: var(--primary-yellow-light);
    border-bottom: 3px solid var(--primary-yellow);
  }

  .nav-end {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .location-info {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--primary-yellow-light);
    border-radius: var(--border-radius-sm);
    font-size: 0.8em;
    font-weight: 600;
    color: var(--primary-yellow);
  }

  .nav-profile {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: var(--gradient-yellow);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: var(--card-white);
    cursor: pointer;
    position: relative;
  }

  .achievements-badge {
    position: absolute;
    top: -2px;
    right: -2px;
    width: 16px;
    height: 16px;
    background: var(--error-red);
    border-radius: 50%;
    font-size: 0.7em;
    display: none;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
  }

  /* CONTAINER */
  .container {
    max-width: 1200px;
    margin: 24px auto;
    padding: 0 20px;
  }

  /* PANELS */
  .panel {
    display: none;
  }

  .panel.active {
    display: block;
  }

  /* BUTTONS */
  .btn {
    background: var(--gradient-yellow);
    color: var(--card-white);
    border: none;
    padding: 12px 20px;
    border-radius: var(--border-radius-sm);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-smooth);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9em;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
  }

  .btn-secondary { background: var(--info-blue); }
  .btn-success { background: var(--success-green); }
  .btn-warning { background: var(--warning-orange); }
  .btn-danger { background: var(--error-red); }

  /* VEHICLE SELECTOR */
  .vehicle-selector {
    background: var(--card-white);
    border-radius: var(--border-radius-lg);
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: var(--shadow-soft);
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .vehicle-select {
    padding: 12px 16px;
    border: 2px solid var(--primary-yellow);
    border-radius: var(--border-radius-sm);
    background: var(--card-white);
    font-weight: 600;
    min-width: 150px;
    cursor: pointer;
  }

  .vehicle-select:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(255, 214, 0, 0.3);
  }

  /* BUDGET PANEL */
  .budget-panel {
    background: var(--card-white);
    border-radius: var(--border-radius-lg);
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: var(--shadow-soft);
  }

  .budget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .budget-progress {
    width: 100%;
    height: 12px;
    background: var(--border-light);
    border-radius: 6px;
    margin: 12px 0;
    overflow: hidden;
  }

  .budget-progress-bar {
    height: 100%;
    background: var(--gradient-yellow);
    border-radius: 6px;
    transition: width 0.5s ease;
  }

  .budget-progress-bar.warning { background: var(--warning-orange); }
  .budget-progress-bar.danger { background: var(--error-red); }

  .budget-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 16px;
    margin-top: 16px;
  }

  .budget-stat {
    text-align: center;
    padding: 12px;
    background: var(--primary-yellow-light);
    border-radius: var(--border-radius-sm);
  }

  .budget-stat-value {
    font-size: 1.4em;
    font-weight: 700;
    color: var(--primary-yellow);
  }

  .budget-stat-label {
    font-size: 0.85em;
    color: var(--medium-text);
    margin-top: 4px;
  }

  /* LIVE PRICES */
  .live-prices-panel {
    background: var(--card-white);
    border-radius: var(--border-radius-lg);
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: var(--shadow-soft);
  }

  .live-prices-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .price-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }

  .price-card {
    background: var(--primary-yellow-light);
    border-radius: var(--border-radius-md);
    padding: 16px;
    text-align: center;
    border: 2px solid var(--primary-yellow);
    transition: var(--transition-smooth);
  }

  .price-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
  }

  .fuel-type {
    font-size: 0.9em;
    font-weight: 700;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .fuel-price {
    font-size: 1.5em;
    font-weight: 700;
    color: var(--primary-yellow);
  }

  .price-change {
    font-size: 0.8em;
    margin-top: 4px;
    font-weight: 600;
  }

  .price-change.up { color: var(--error-red); }
  .price-change.down { color: var(--success-green); }
  .price-change.neutral { color: var(--medium-text); }

  /* DASHBOARD GRID */
  .dash-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }

  .main-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }

  .card {
    background: var(--card-white);
    border-radius: var(--border-radius-lg);
    padding: 20px;
    box-shadow: var(--shadow-soft);
    transition: var(--transition-smooth);
    border: 1px solid var(--border-light);
  }

  .card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-medium);
  }

  .card-title {
    font-size: 1em;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--medium-text);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .big-number {
    font-size: 1.8em;
    font-weight: 700;
    background: var(--gradient-yellow);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .dash-charts {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .side-cards {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .side-box {
    background: var(--card-white);
    border-radius: var(--border-radius-md);
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: var(--shadow-soft);
    transition: var(--transition-smooth);
  }

  .side-box:hover {
    transform: translateX(4px);
  }

  .side-box-icon {
    background: var(--gradient-yellow);
    color: var(--card-white);
    width: 40px;
    height: 40px;
    border-radius: var(--border-radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3em;
  }

  /* FORMS */
  .form-container {
    background: var(--card-white);
    border-radius: var(--border-radius-lg);
    padding: 24px;
    box-shadow: var(--shadow-soft);
    margin-bottom: 24px;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }

  .form-row input,
  .form-row select,
  .form-row button {
    padding: 14px 16px;
    border: 2px solid var(--border-light);
    border-radius: var(--border-radius-sm);
    font-family: inherit;
    font-size: 1rem;
    transition: var(--transition-smooth);
    background: var(--card-white);
  }

  .form-row input:focus,
  .form-row select:focus {
    outline: none;
    border-color: var(--primary-yellow);
    box-shadow: 0 0 0 3px rgba(255, 214, 0, 0.3);
  }

  .form-row input[readonly],
  .form-row input[disabled] {
    background: var(--background-gray);
    color: var(--medium-text);
  }

  /* NOTIFICATIONS */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 2000;
    padding: 12px 20px;
    border-radius: var(--border-radius-sm);
    box-shadow: var(--shadow-medium);
    font-weight: 600;
    animation: slideIn 0.3s ease;
    max-width: 300px;
  }

  .notification.success { background: var(--success-green); color: white; }
  .notification.error { background: var(--error-red); color: white; }
  .notification.info { background: var(--info-blue); color: white; }
  .notification.warning { background: var(--warning-orange); color: white; }

  @keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
  }

  /* TABLE */
  .table-container {
    background: var(--card-white);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-soft);
    overflow-x: auto;
    margin-bottom: 24px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85em;
  }

  th, td {
    padding: 12px 8px;
    text-align: center;
    border-bottom: 1px solid var(--border-light);
  }

  th {
    background: var(--primary-yellow-light);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.8em;
  }

  tbody tr:hover {
    background: var(--primary-yellow-light);
  }

  .act-btn {
    background: var(--gradient-yellow);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: var(--border-radius-sm);
    font-size: 0.75em;
    cursor: pointer;
    margin: 2px;
    transition: var(--transition-smooth);
  }

  .act-btn:hover {
    transform: translateY(-1px);
  }

  .act-btn.delete { background: var(--error-red); }
  .act-btn.edit { background: var(--info-blue); }

  .mileage-cell {
    font-weight: 700;
    color: var(--success-green);
  }

  /* Current vehicle indicator */
  .current-vehicle {
    background: var(--success-green);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.7em;
    margin-left: 8px;
  }

  /* RESPONSIVE DESIGN */
  @media (max-width: 768px) {
    .navbar {
      padding: 12px 16px;
    }

    .nav-logo {
      font-size: 1.5rem;
    }

    .nav-menu {
      order: 2;
      width: 100%;
      justify-content: center;
      margin: 8px 0;
      gap: 6px;
    }

    .nav-menu span {
      padding: 6px 8px;
      font-size: 0.75rem;
    }

    .nav-end {
      order: 1;
      margin-left: auto;
    }

    .container {
      padding: 0 16px;
      margin: 16px auto;
    }

    .dash-grid {
      grid-template-columns: 1fr;
    }

    .main-cards {
      grid-template-columns: repeat(2, 1fr);
    }

    .dash-charts {
      grid-template-columns: 1fr;
    }

    .side-cards {
      flex-direction: row;
      flex-wrap: wrap;
    }

    .side-box {
      flex: 1;
      min-width: 140px;
    }

    .price-grid {
      grid-template-columns: 1fr;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .budget-stats {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 480px) {
    .navbar {
      flex-direction: column;
      align-items: stretch;
    }

    .nav-logo {
      text-align: center;
      margin: 8px 0;
    }

    .nav-menu {
      order: 1;
      margin: 8px 0;
    }

    .nav-end {
      order: 2;
      justify-content: center;
      flex-wrap: wrap;
      margin: 8px 0;
    }

    .location-info {
      order: 3;
      width: 100%;
      text-align: center;
      margin: 8px 0;
    }

    .vehicle-selector {
      flex-direction: column;
      align-items: stretch;
    }

    .main-cards {
      grid-template-columns: 1fr;
    }

    .side-cards {
      flex-direction: column;
    }
  }
</style>
</head>
<body>
  <!-- NAVIGATION -->
  <div class="navbar">
    <div class="nav-logo">‚õΩ FuelTracker Pro</div>
    <div class="nav-menu">
      <span id="tab-dashboard" class="active">üè† Dashboard</span>
      <span id="tab-expenses">üìù Expenses</span>
      <span id="tab-vehicles">üöó Vehicles</span>
      <span id="tab-budget">üí∞ Budget</span>
      <span id="tab-reports">üìä Reports</span>
      <span id="tab-settings">‚öôÔ∏è Settings</span>
    </div>
    <div class="nav-end">
      <div class="location-info">üìç <span id="current-location">Chennai, TN</span></div>
      <span style="font-size: 1.2em; cursor: pointer;" title="Notifications">üîî</span>
      <div class="nav-profile">
        P
        <div class="achievements-badge" id="achievements-badge">0</div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- DASHBOARD PANEL -->
    <div class="panel active" id="dashboard-panel">
      <!-- Vehicle Selector -->
      <div class="vehicle-selector">
        <strong>üöó Current Vehicle:</strong>
        <select class="vehicle-select" id="vehicle-selector">
          <option value="default">My Car</option>
        </select>
        <span id="current-vehicle-indicator" class="current-vehicle">ACTIVE</span>
        <button class="btn" id="add-vehicle-btn">‚ûï Add Vehicle</button>
        <button class="btn btn-secondary" id="export-data-btn">üìÑ Export</button>
        <button class="btn btn-success" id="backup-data-btn">‚òÅÔ∏è Backup</button>
      </div>

      <!-- Budget Panel -->
      <div class="budget-panel">
        <div class="budget-header">
          <h3 style="margin: 0;">üí∞ Monthly Budget</h3>
          <button class="btn" id="set-budget-btn">Set Budget</button>
        </div>
        <div class="budget-progress">
          <div class="budget-progress-bar" id="budget-progress-bar" style="width: 0%"></div>
        </div>
        <div class="budget-stats">
          <div class="budget-stat">
            <div class="budget-stat-value" id="budget-spent">‚Çπ 0</div>
            <div class="budget-stat-label">Spent</div>
          </div>
          <div class="budget-stat">
            <div class="budget-stat-value" id="budget-remaining">‚Çπ 0</div>
            <div class="budget-stat-label">Remaining</div>
          </div>
          <div class="budget-stat">
            <div class="budget-stat-value" id="budget-target">‚Çπ 0</div>
            <div class="budget-stat-label">Target</div>
          </div>
          <div class="budget-stat">
            <div class="budget-stat-value" id="budget-days">30</div>
            <div class="budget-stat-label">Days Left</div>
          </div>
        </div>
      </div>

      <!-- Live Fuel Prices -->
      <div class="live-prices-panel">
        <div class="live-prices-header">
          <h3 style="margin: 0;">üìà Live Fuel Prices</h3>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn btn-secondary" id="detect-location">üìç Detect</button>
            <button class="btn" id="refresh-prices">üîÑ Refresh</button>
            <button class="btn btn-success" id="price-alerts">üîî Set Alert</button>
          </div>
        </div>
        <div class="price-grid">
          <div class="price-card">
            <div class="fuel-type">Petrol</div>
            <div class="fuel-price" id="petrol-price">‚Çπ 100.79</div>
            <div class="price-change up" id="petrol-change">+‚Çπ0.41 ‚ñ≤</div>
          </div>
          <div class="price-card">
            <div class="fuel-type">Diesel</div>
            <div class="fuel-price" id="diesel-price">‚Çπ 92.38</div>
            <div class="price-change up" id="diesel-change">+‚Çπ0.12 ‚ñ≤</div>
          </div>
          <div class="price-card">
            <div class="fuel-type">CNG</div>
            <div class="fuel-price" id="cng-price">‚Çπ 75.00</div>
            <div class="price-change down" id="cng-change">-‚Çπ0.28 ‚ñº</div>
          </div>
        </div>
        <div style="text-align: center; margin-top: 12px; font-size: 0.8em; color: var(--medium-text);" id="last-updated">
          Last updated: Now - Chennai, Tamil Nadu
        </div>
      </div>

      <!-- Dashboard Grid -->
      <div class="dash-grid">
        <div>
          <div class="main-cards">
            <div class="card">
              <div class="card-title">üí∞ Total Spent</div>
              <div class="big-number" id="dash-total">‚Çπ 0</div>
            </div>
            <div class="card">
              <div class="card-title">‚õΩ Avg Mileage</div>
              <div class="big-number" id="dash-mileage">0 km/L</div>
            </div>
            <div class="card">
              <div class="card-title">üìà Cost/KM</div>
              <div class="big-number" id="dash-cost-per-km">‚Çπ 0</div>
            </div>
            <div class="card">
              <div class="card-title">üéØ Efficiency</div>
              <div class="big-number" id="dash-efficiency">0%</div>
            </div>
          </div>
          <div class="dash-charts">
            <div class="card">
              <div class="card-title">üìä Monthly Spend</div>
              <canvas id="lineChart" height="110"></canvas>
            </div>
            <div class="card">
              <div class="card-title">ü•ß Expense Types</div>
              <canvas id="pieChart" height="110"></canvas>
            </div>
          </div>
        </div>
        <div class="side-cards">
          <div class="side-box">
            <div class="side-box-icon">üöó</div>
            <div><b id="dash-fuel-ups">0</b> Fuel ups</div>
          </div>
          <div class="side-box">
            <div class="side-box-icon">üìà</div>
            <div><b id="dash-max-amount">‚Çπ 0</b> Max fuel</div>
          </div>
          <div class="side-box">
            <div class="side-box-icon">üìä</div>
            <div><b id="dash-max-distance">0 km</b> Longest trip</div>
          </div>
          <div class="side-box">
            <div class="side-box-icon">‚≠ê</div>
            <div><b id="dash-best-mileage">0 km/L</b> Best mileage</div>
          </div>
        </div>
      </div>
    </div>

    <!-- EXPENSES PANEL -->
    <div class="panel" id="expenses-panel">
      <h2 style="text-align: center; margin-bottom: 24px;">üìù Add & Manage Expenses</h2>

      <div class="form-container">
        <form id="expense-form">
          <div class="form-row">
            <input type="date" id="date" required />
            <select id="fuel-type" required>
              <option value="">Select Fuel Type</option>
              <option value="petrol">Petrol</option>
              <option value="diesel">Diesel</option>
              <option value="cng">CNG</option>
            </select>
            <input type="number" id="amount" placeholder="Total Amount (‚Çπ)" step="0.01" min="0" required />
            <input type="number" id="rate" placeholder="Rate per Litre (‚Çπ)" step="0.01" min="0" required />
            <button type="button" class="btn btn-secondary" id="use-live-rate">üìç Use Live Rate</button>
            <input type="number" id="litres" placeholder="Litres" step="0.01" readonly />
            <input type="number" id="fuel-cost" placeholder="Pure Fuel Cost (‚Çπ)" step="0.01" readonly />
            <input type="number" id="additives" placeholder="Additives/Others (‚Çπ)" step="0.01" min="0" />
            <input type="number" id="start-km" placeholder="Start Odometer (KM)" step="0.1" min="0" />
            <input type="number" id="end-km" placeholder="End Odometer (KM)" step="0.1" min="0" />
            <input type="number" id="calculated-mileage" placeholder="Calculated Mileage" step="0.01" readonly />
            <input type="text" id="fuel-station" placeholder="Fuel Station Name" />
            <button type="submit" id="add-expense-btn">‚ûï Add Expense</button>
            <button type="button" id="update-expense-btn" style="display:none;">‚úèÔ∏è Update Expense</button>
            <button type="button" id="cancel-edit-btn" style="display:none;">‚ùå Cancel Edit</button>
          </div>
        </form>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Amount</th>
              <th>Rate/L</th>
              <th>Litres</th>
              <th>Mileage</th>
              <th>Station</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="expenses-table-body">
            <tr id="no-expenses-row">
              <td colspan="8" style="text-align: center; padding: 40px; color: var(--medium-text);">
                No expenses added yet. Add your first fuel expense above! üöó
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- VEHICLES PANEL -->
    <div class="panel" id="vehicles-panel">
      <h2 style="text-align: center; margin-bottom: 24px;">üöó Vehicle Management</h2>

      <div class="form-container">
        <h3>Add New Vehicle</h3>
        <form id="vehicle-form">
          <div class="form-row">
            <input type="text" id="vehicle-name" placeholder="Vehicle Name (e.g., My Honda City)" required />
            <select id="vehicle-type" required>
              <option value="">Select Vehicle Type</option>
              <option value="car">Car</option>
              <option value="bike">Motorcycle</option>
              <option value="truck">Truck</option>
              <option value="other">Other</option>
            </select>
            <select id="primary-fuel-type" required>
              <option value="">Primary Fuel Type</option>
              <option value="petrol">Petrol</option>
              <option value="diesel">Diesel</option>
              <option value="cng">CNG</option>
            </select>
            <input type="text" id="vehicle-model" placeholder="Make & Model (e.g., Honda City 2020)" />
            <input type="number" id="vehicle-year" placeholder="Year" min="1980" max="2030" />
            <button type="submit">‚ûï Add Vehicle</button>
          </div>
        </form>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Fuel</th>
              <th>Model</th>
              <th>Year</th>
              <th>Total Spent</th>
              <th>Avg Mileage</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="vehicles-table-body">
            <tr>
              <td>My Car</td>
              <td>Car</td>
              <td>Petrol</td>
              <td>Default Vehicle</td>
              <td>-</td>
              <td id="default-vehicle-spent">‚Çπ 0</td>
              <td id="default-vehicle-mileage">0 km/L</td>
              <td><span style="color: var(--medium-text); font-size: 0.8em;">Default</span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- BUDGET PANEL -->
    <div class="panel" id="budget-panel">
      <h2 style="text-align: center; margin-bottom: 24px;">üí∞ Budget Management</h2>

      <div class="form-container">
        <h3>Set Monthly Budget</h3>
        <div class="form-row">
          <input type="number" id="monthly-budget-input" placeholder="Monthly Budget Amount (‚Çπ)" min="0" step="100" />
          <button type="button" class="btn" id="save-budget-btn">üíæ Save Budget</button>
          <button type="button" class="btn btn-secondary" id="reset-budget-btn">üîÑ Reset Budget</button>
        </div>
        <div style="margin-top: 16px; padding: 12px; background: var(--primary-yellow-light); border-radius: var(--border-radius-sm);">
          <strong>üí° Budget Tips:</strong>
          <ul style="margin: 8px 0; padding-left: 20px;">
            <li>Set a realistic monthly fuel budget based on your usage</li>
            <li>Get alerts when you reach 80% and 90% of your budget</li>
            <li>Track your spending patterns to optimize fuel costs</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- REPORTS PANEL -->
    <div class="panel" id="reports-panel">
      <h2 style="text-align: center; margin-bottom: 24px;">üìä Reports & Analytics</h2>

      <div class="form-container">
        <h3>Export Reports</h3>
        <div class="form-row">
          <button type="button" class="btn btn-success" id="export-excel-btn">üìä Export to Excel</button>
          <button type="button" class="btn btn-secondary" id="export-pdf-btn">üìÑ Generate PDF Report</button>
          <button type="button" class="btn" id="export-csv-btn">üìã Export to CSV</button>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <div class="card">
          <div class="card-title">üìà Monthly Spending Trends</div>
          <canvas id="monthlyChart" height="200"></canvas>
        </div>
        <div class="card">
          <div class="card-title">‚õΩ Fuel Efficiency Over Time</div>
          <canvas id="efficiencyChart" height="200"></canvas>
        </div>
        <div class="card">
          <div class="card-title">üè™ Station Usage Analysis</div>
          <canvas id="stationChart" height="200"></canvas>
        </div>
        <div class="card">
          <div class="card-title">üìä Fuel Type Distribution</div>
          <canvas id="fuelTypeChart" height="200"></canvas>
        </div>
      </div>
    </div>

    <!-- SETTINGS PANEL -->
    <div class="panel" id="settings-panel">
      <h2 style="text-align: center; margin-bottom: 24px;">‚öôÔ∏è Settings</h2>

      <div class="form-container">
        <h3>üîî Notifications</h3>
        <div style="display: grid; gap: 12px;">
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="price-alerts-setting" /> 
            <span>Price Drop Alerts</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="budget-alerts-setting" checked /> 
            <span>Budget Warning Alerts</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="maintenance-alerts-setting" /> 
            <span>Maintenance Reminders</span>
          </label>
        </div>

        <h3>üìä Data Management</h3>
        <div class="form-row">
          <input type="file" id="import-file" accept=".json" style="display: none;" />
          <button type="button" class="btn" id="import-data-btn">üì• Import Data</button>
          <button type="button" class="btn btn-warning" id="backup-all-btn">üíæ Backup All Data</button>
          <button type="button" class="btn btn-danger" id="clear-all-btn">üóëÔ∏è Clear All Data</button>
        </div>

        <h3>üé® Preferences</h3>
        <div class="form-row">
          <select id="currency-setting">
            <option value="INR">Indian Rupee (‚Çπ)</option>
            <option value="USD">US Dollar ($)</option>
            <option value="EUR">Euro (‚Ç¨)</option>
          </select>
          <select id="date-format-setting">
            <option value="DD/MM/YYYY">DD/MM/YYYY</option>
            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
          </select>
        </div>
      </div>
    </div>
  </div>

<script>
// ===== FULLY FUNCTIONAL FUELTRACKER PRO - FIXED VERSION =====

// Data Storage
const FuelTrackerData = {
  expenses: JSON.parse(localStorage.getItem('fuelTracker_expenses')) || [],
  vehicles: JSON.parse(localStorage.getItem('fuelTracker_vehicles')) || [
    { id: 'default', name: 'My Car', type: 'car', fuelType: 'petrol', model: 'Default Vehicle', year: null }
  ],
  budget: JSON.parse(localStorage.getItem('fuelTracker_budget')) || { monthly: 0, alerts: true },
  settings: JSON.parse(localStorage.getItem('fuelTracker_settings')) || {
    priceAlerts: false,
    budgetAlerts: true,
    maintenanceAlerts: false,
    currency: 'INR',
    dateFormat: 'DD/MM/YYYY'
  },
  currentVehicle: localStorage.getItem('fuelTracker_currentVehicle') || 'default'
};

// Current edit state
let editingExpenseId = null;

// Chart instances to track for destruction
let dashboardCharts = {
  lineChart: null,
  pieChart: null,
  monthlyChart: null,
  efficiencyChart: null,
  stationChart: null,
  fuelTypeChart: null
};

// Fuel prices data
const fuelPrices = {
  'Chennai': { petrol: 100.79, diesel: 92.38, cng: 75.00 },
  'Mumbai': { petrol: 104.19, diesel: 92.13, cng: 76.00 },
  'Delhi': { petrol: 94.81, diesel: 87.71, cng: 76.59 },
  'Kolkata': { petrol: 104.99, diesel: 91.81, cng: 90.00 },
  'Bangalore': { petrol: 102.86, diesel: 88.87, cng: 78.00 }
};

let currentLocation = 'Chennai';

// Save data to localStorage
function saveData() {
  localStorage.setItem('fuelTracker_expenses', JSON.stringify(FuelTrackerData.expenses));
  localStorage.setItem('fuelTracker_vehicles', JSON.stringify(FuelTrackerData.vehicles));
  localStorage.setItem('fuelTracker_budget', JSON.stringify(FuelTrackerData.budget));
  localStorage.setItem('fuelTracker_settings', JSON.stringify(FuelTrackerData.settings));
  localStorage.setItem('fuelTracker_currentVehicle', FuelTrackerData.currentVehicle);
}

// Notification System
function showNotification(message, type = 'info', duration = 3000) {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);

  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, duration);
}

// Navigation System
function initNavigation() {
  const tabs = document.querySelectorAll('.nav-menu span');
  const panels = document.querySelectorAll('.panel');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));

      tab.classList.add('active');

      const panelId = tab.id.replace('tab-', '') + '-panel';
      const targetPanel = document.getElementById(panelId);
      if (targetPanel) {
        targetPanel.classList.add('active');
      }

      // Load specific data for panel
      loadPanelData(panelId);
    });
  });
}

function loadPanelData(panelId) {
  switch(panelId) {
    case 'dashboard-panel':
      updateDashboard();
      break;
    case 'expenses-panel':
      renderExpensesTable();
      break;
    case 'vehicles-panel':
      renderVehiclesTable();
      break;
    case 'reports-panel':
      renderReportsCharts();
      break;
  }
}

// FIXED: Vehicle Management with proper switching
function initVehicles() {
  const vehicleSelector = document.getElementById('vehicle-selector');

  // Populate vehicle selector
  function populateVehicleSelector() {
    vehicleSelector.innerHTML = '';
    FuelTrackerData.vehicles.forEach(vehicle => {
      const option = document.createElement('option');
      option.value = vehicle.id;
      option.textContent = vehicle.name;
      vehicleSelector.appendChild(option);
    });

    // Set current vehicle
    vehicleSelector.value = FuelTrackerData.currentVehicle;
    updateCurrentVehicleIndicator();
  }

  function updateCurrentVehicleIndicator() {
    const currentVehicle = FuelTrackerData.vehicles.find(v => v.id === FuelTrackerData.currentVehicle);
    const indicator = document.getElementById('current-vehicle-indicator');
    if (currentVehicle) {
      indicator.textContent = `${currentVehicle.name.toUpperCase()}`;
    }
  }

  populateVehicleSelector();

  // FIXED: Vehicle selector change event
  vehicleSelector.addEventListener('change', (e) => {
    console.log('Vehicle changed from', FuelTrackerData.currentVehicle, 'to', e.target.value);
    FuelTrackerData.currentVehicle = e.target.value;
    saveData();
    updateCurrentVehicleIndicator();
    updateDashboard();
    renderExpensesTable();
    showNotification(`Switched to: ${e.target.selectedOptions[0].text}`, 'success');
  });

  // Add vehicle form
  document.getElementById('vehicle-form').addEventListener('submit', (e) => {
    e.preventDefault();

    const name = document.getElementById('vehicle-name').value.trim();
    const type = document.getElementById('vehicle-type').value;
    const fuelType = document.getElementById('primary-fuel-type').value;
    const model = document.getElementById('vehicle-model').value.trim();
    const year = document.getElementById('vehicle-year').value;

    if (!name || !type || !fuelType) {
      showNotification('Please fill all required fields!', 'error');
      return;
    }

    const newVehicle = {
      id: Date.now().toString(),
      name,
      type,
      fuelType,
      model: model || 'Not specified',
      year: year || null
    };

    FuelTrackerData.vehicles.push(newVehicle);
    saveData();

    populateVehicleSelector();
    renderVehiclesTable();

    // Clear form
    document.getElementById('vehicle-form').reset();

    showNotification(`Vehicle "${name}" added successfully!`, 'success');
  });
}

function renderVehiclesTable() {
  const tbody = document.getElementById('vehicles-table-body');
  tbody.innerHTML = '';

  FuelTrackerData.vehicles.forEach((vehicle, index) => {
    const vehicleExpenses = getVehicleExpenses(vehicle.id);
    const totalSpent = vehicleExpenses.reduce((sum, exp) => sum + Number(exp.amount), 0);
    const avgMileage = calculateAverageMileage(vehicleExpenses);

    const row = document.createElement('tr');
    const isCurrentVehicle = vehicle.id === FuelTrackerData.currentVehicle;

    row.innerHTML = `
      <td>
        <strong>${vehicle.name}</strong>
        ${isCurrentVehicle ? '<span class="current-vehicle">CURRENT</span>' : ''}
      </td>
      <td>${vehicle.type}</td>
      <td>${vehicle.fuelType}</td>
      <td>${vehicle.model}</td>
      <td>${vehicle.year || '-'}</td>
      <td>‚Çπ ${totalSpent.toLocaleString()}</td>
      <td>${avgMileage} km/L</td>
      <td>
        ${vehicle.id === 'default' ? 
          '<span style="color: var(--medium-text); font-size: 0.8em;">Default</span>' : 
          `<button class="act-btn delete" onclick="deleteVehicle('${vehicle.id}')">Delete</button>`
        }
      </td>
    `;
    tbody.appendChild(row);
  });
}

function deleteVehicle(vehicleId) {
  if (confirm('Are you sure you want to delete this vehicle? Associated expenses will be moved to default vehicle.')) {
    // Move expenses to default vehicle
    FuelTrackerData.expenses.forEach(expense => {
      if (expense.vehicleId === vehicleId) {
        expense.vehicleId = 'default';
      }
    });

    // Remove vehicle
    FuelTrackerData.vehicles = FuelTrackerData.vehicles.filter(v => v.id !== vehicleId);

    // Update current vehicle if needed
    if (FuelTrackerData.currentVehicle === vehicleId) {
      FuelTrackerData.currentVehicle = 'default';
    }

    saveData();
    initVehicles(); // Reinitialize to update dropdown
    updateDashboard();
    renderVehiclesTable();

    showNotification('Vehicle deleted successfully!', 'success');
  }
}

window.deleteVehicle = deleteVehicle;

// Expense Management (unchanged but working)
function initExpenses() {
  const expenseForm = document.getElementById('expense-form');
  const addBtn = document.getElementById('add-expense-btn');
  const updateBtn = document.getElementById('update-expense-btn');
  const cancelBtn = document.getElementById('cancel-edit-btn');

  // Auto calculations
  const amountInput = document.getElementById('amount');
  const rateInput = document.getElementById('rate');
  const additivesInput = document.getElementById('additives');
  const startKmInput = document.getElementById('start-km');
  const endKmInput = document.getElementById('end-km');
  const litresInput = document.getElementById('litres');
  const fuelCostInput = document.getElementById('fuel-cost');
  const mileageInput = document.getElementById('calculated-mileage');

  function calculateValues() {
    const amount = Number(amountInput.value) || 0;
    const rate = Number(rateInput.value) || 0;
    const additives = Number(additivesInput.value) || 0;
    const startKm = Number(startKmInput.value) || 0;
    const endKm = Number(endKmInput.value) || 0;

    // Calculate fuel cost and litres
    const fuelCost = amount - additives;
    const litres = rate > 0 ? fuelCost / rate : 0;

    fuelCostInput.value = fuelCost > 0 ? fuelCost.toFixed(2) : '';
    litresInput.value = litres > 0 ? litres.toFixed(2) : '';

    // Calculate mileage
    const distance = endKm - startKm;
    if (distance > 0 && litres > 0) {
      mileageInput.value = (distance / litres).toFixed(2);
    } else {
      mileageInput.value = '';
    }
  }

  // Add calculation listeners
  [amountInput, rateInput, additivesInput, startKmInput, endKmInput].forEach(input => {
    input.addEventListener('input', calculateValues);
  });

  // Use live rate button
  document.getElementById('use-live-rate').addEventListener('click', () => {
    const fuelType = document.getElementById('fuel-type').value;
    if (!fuelType) {
      showNotification('Please select fuel type first!', 'warning');
      return;
    }

    const price = fuelPrices[currentLocation][fuelType];
    if (price) {
      rateInput.value = price.toFixed(2);
      calculateValues();
      showNotification(`Live ${fuelType} rate filled: ‚Çπ${price}`, 'success');
    }
  });

  // Form submission
  expenseForm.addEventListener('submit', (e) => {
    e.preventDefault();

    const formData = {
      id: editingExpenseId || Date.now().toString(),
      date: document.getElementById('date').value,
      fuelType: document.getElementById('fuel-type').value,
      amount: Number(document.getElementById('amount').value),
      rate: Number(document.getElementById('rate').value),
      litres: Number(document.getElementById('litres').value),
      fuelCost: Number(document.getElementById('fuel-cost').value),
      additives: Number(document.getElementById('additives').value) || 0,
      startKm: Number(document.getElementById('start-km').value) || 0,
      endKm: Number(document.getElementById('end-km').value) || 0,
      mileage: Number(document.getElementById('calculated-mileage').value) || 0,
      station: document.getElementById('fuel-station').value.trim(),
      vehicleId: FuelTrackerData.currentVehicle,
      timestamp: Date.now()
    };

    if (editingExpenseId) {
      // Update existing expense
      const index = FuelTrackerData.expenses.findIndex(exp => exp.id === editingExpenseId);
      if (index !== -1) {
        FuelTrackerData.expenses[index] = formData;
        showNotification('Expense updated successfully!', 'success');
      }
    } else {
      // Add new expense
      FuelTrackerData.expenses.push(formData);
      showNotification('Expense added successfully!', 'success');
    }

    saveData();
    expenseForm.reset();
    resetEditMode();
    renderExpensesTable();
    updateDashboard();
  });

  // Cancel edit
  cancelBtn.addEventListener('click', () => {
    expenseForm.reset();
    resetEditMode();
  });

  function resetEditMode() {
    editingExpenseId = null;
    addBtn.style.display = 'inline-flex';
    updateBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
  }
}

function renderExpensesTable() {
  const tbody = document.getElementById('expenses-table-body');

  const vehicleExpenses = getVehicleExpenses(FuelTrackerData.currentVehicle);

  if (vehicleExpenses.length === 0) {
    tbody.innerHTML = `
      <tr id="no-expenses-row">
        <td colspan="8" style="text-align: center; padding: 40px; color: var(--medium-text);">
          No expenses found for this vehicle. Add your first expense above! üöó
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = '';

  // Sort by date, newest first
  vehicleExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

  vehicleExpenses.forEach(expense => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${formatDate(expense.date)}</td>
      <td>${expense.fuelType || 'Petrol'}</td>
      <td>‚Çπ ${expense.amount.toLocaleString()}</td>
      <td>‚Çπ ${expense.rate.toFixed(2)}</td>
      <td>${expense.litres.toFixed(2)} L</td>
      <td class="mileage-cell">${expense.mileage ? expense.mileage.toFixed(2) + ' km/L' : '-'}</td>
      <td>${expense.station || '-'}</td>
      <td>
        <button class="act-btn edit" onclick="editExpense('${expense.id}')">Edit</button>
        <button class="act-btn delete" onclick="deleteExpense('${expense.id}')">Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function editExpense(expenseId) {
  const expense = FuelTrackerData.expenses.find(exp => exp.id === expenseId);
  if (!expense) return;

  // Switch to expenses tab if not active
  document.getElementById('tab-expenses').click();

  // Fill form with expense data
  document.getElementById('date').value = expense.date;
  document.getElementById('fuel-type').value = expense.fuelType;
  document.getElementById('amount').value = expense.amount;
  document.getElementById('rate').value = expense.rate;
  document.getElementById('additives').value = expense.additives || 0;
  document.getElementById('start-km').value = expense.startKm || '';
  document.getElementById('end-km').value = expense.endKm || '';
  document.getElementById('fuel-station').value = expense.station || '';

  // Calculate derived values
  document.getElementById('litres').value = expense.litres.toFixed(2);
  document.getElementById('fuel-cost').value = expense.fuelCost.toFixed(2);
  document.getElementById('calculated-mileage').value = expense.mileage ? expense.mileage.toFixed(2) : '';

  // Set edit mode
  editingExpenseId = expenseId;
  document.getElementById('add-expense-btn').style.display = 'none';
  document.getElementById('update-expense-btn').style.display = 'inline-flex';
  document.getElementById('cancel-edit-btn').style.display = 'inline-flex';

  // Scroll to form
  document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });

  showNotification('Edit mode activated. Make changes and click Update.', 'info');
}

function deleteExpense(expenseId) {
  if (confirm('Are you sure you want to delete this expense?')) {
    FuelTrackerData.expenses = FuelTrackerData.expenses.filter(exp => exp.id !== expenseId);
    saveData();
    renderExpensesTable();
    updateDashboard();
    showNotification('Expense deleted successfully!', 'success');
  }
}

// Make functions available globally
window.editExpense = editExpense;
window.deleteExpense = deleteExpense;

// Helper Functions
function getVehicleExpenses(vehicleId) {
  return FuelTrackerData.expenses.filter(exp => exp.vehicleId === vehicleId);
}

function calculateAverageMileage(expenses) {
  const validMileages = expenses.filter(exp => exp.mileage > 0).map(exp => exp.mileage);
  if (validMileages.length === 0) return 0;
  return (validMileages.reduce((sum, mileage) => sum + mileage, 0) / validMileages.length).toFixed(1);
}

function formatDate(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-IN');
}

function getCurrentMonthExpenses() {
  const currentMonth = new Date().toISOString().slice(0, 7);
  return getVehicleExpenses(FuelTrackerData.currentVehicle)
    .filter(exp => exp.date && exp.date.startsWith(currentMonth));
}

// Dashboard Updates
function updateDashboard() {
  const expenses = getVehicleExpenses(FuelTrackerData.currentVehicle);

  // Calculate metrics
  const totalSpent = expenses.reduce((sum, exp) => sum + exp.amount, 0);
  const avgMileage = calculateAverageMileage(expenses);
  const totalDistance = expenses.reduce((sum, exp) => sum + (exp.endKm - exp.startKm), 0);
  const costPerKm = totalDistance > 0 ? totalSpent / totalDistance : 0;
  const efficiency = avgMileage > 0 ? Math.min(100, (avgMileage / 20) * 100) : 0;
  const maxAmount = expenses.length > 0 ? Math.max(...expenses.map(exp => exp.amount)) : 0;
  const maxDistance = expenses.length > 0 ? Math.max(...expenses.map(exp => exp.endKm - exp.startKm)) : 0;
  const bestMileage = expenses.length > 0 ? Math.max(...expenses.map(exp => exp.mileage || 0)) : 0;

  // Update dashboard cards
  document.getElementById('dash-total').textContent = `‚Çπ ${totalSpent.toLocaleString()}`;
  document.getElementById('dash-mileage').textContent = `${avgMileage} km/L`;
  document.getElementById('dash-cost-per-km').textContent = `‚Çπ ${costPerKm.toFixed(2)}`;
  document.getElementById('dash-efficiency').textContent = `${efficiency.toFixed(0)}%`;

  // Update side cards
  document.getElementById('dash-fuel-ups').textContent = expenses.length;
  document.getElementById('dash-max-amount').textContent = `‚Çπ ${maxAmount.toLocaleString()}`;
  document.getElementById('dash-max-distance').textContent = `${maxDistance} km`;
  document.getElementById('dash-best-mileage').textContent = `${bestMileage.toFixed(1)} km/L`;

  // Update budget
  updateBudgetDisplay();

  // Update charts
  updateDashboardCharts();
}

function updateBudgetDisplay() {
  const currentMonthExpenses = getCurrentMonthExpenses();
  const spent = currentMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
  const budget = FuelTrackerData.budget.monthly || 0;
  const remaining = Math.max(0, budget - spent);
  const percentage = budget > 0 ? (spent / budget) * 100 : 0;

  // Calculate days left in month
  const now = new Date();
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  const daysLeft = lastDay - now.getDate();

  // Update budget display
  document.getElementById('budget-spent').textContent = `‚Çπ ${spent.toLocaleString()}`;
  document.getElementById('budget-remaining').textContent = `‚Çπ ${remaining.toLocaleString()}`;
  document.getElementById('budget-target').textContent = `‚Çπ ${budget.toLocaleString()}`;
  document.getElementById('budget-days').textContent = daysLeft;

  // Update progress bar
  const progressBar = document.getElementById('budget-progress-bar');
  progressBar.style.width = `${Math.min(100, percentage)}%`;
  progressBar.className = 'budget-progress-bar';

  if (percentage > 100) {
    progressBar.classList.add('danger');
  } else if (percentage > 80) {
    progressBar.classList.add('warning');
  }

  // Budget alerts
  if (FuelTrackerData.settings.budgetAlerts && percentage > 90 && budget > 0) {
    showNotification(`Budget Alert: You've used ${percentage.toFixed(0)}% of your monthly budget!`, 'warning', 5000);
  }
}

// FIXED: Dashboard charts with proper cleanup
function updateDashboardCharts() {
  // Monthly spending chart
  const monthlyData = {};
  const expenses = getVehicleExpenses(FuelTrackerData.currentVehicle);

  expenses.forEach(exp => {
    if (!exp.date) return;
    const month = exp.date.slice(0, 7);
    monthlyData[month] = (monthlyData[month] || 0) + exp.amount;
  });

  const months = Object.keys(monthlyData).sort().slice(-6); // Last 6 months
  const amounts = months.map(m => monthlyData[m]);

  // Destroy existing charts if they exist
  if (dashboardCharts.lineChart) {
    dashboardCharts.lineChart.destroy();
    dashboardCharts.lineChart = null;
  }

  if (dashboardCharts.pieChart) {
    dashboardCharts.pieChart.destroy();
    dashboardCharts.pieChart = null;
  }

  // Line chart
  const lineCtx = document.getElementById('lineChart');
  if (lineCtx) {
    dashboardCharts.lineChart = new Chart(lineCtx.getContext('2d'), {
      type: 'line',
      data: {
        labels: months.length ? months : ['No Data'],
        datasets: [{
          data: months.length ? amounts : [0],
          borderColor: '#FFD600',
          backgroundColor: 'rgba(255,214,0,0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
          x: { grid: { display: false } }
        }
      }
    });
  }

  // Pie chart - expense distribution
  const ranges = { 'Small (‚Çπ0-1000)': 0, 'Medium (‚Çπ1001-2000)': 0, 'Large (‚Çπ2001+)': 0 };
  expenses.forEach(exp => {
    if (exp.amount <= 1000) ranges['Small (‚Çπ0-1000)']++;
    else if (exp.amount <= 2000) ranges['Medium (‚Çπ1001-2000)']++;
    else ranges['Large (‚Çπ2001+)']++;
  });

  const pieCtx = document.getElementById('pieChart');
  if (pieCtx) {
    dashboardCharts.pieChart = new Chart(pieCtx.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: expenses.length ? Object.keys(ranges) : ['No Data'],
        datasets: [{
          data: expenses.length ? Object.values(ranges) : [1],
          backgroundColor: expenses.length ? ['#FFD600', '#FFA000', '#FF8F00'] : ['#e0e0e0']
        }]
      },
      options: {
        responsive: true,
        plugins: { 
          legend: { position: 'bottom', labels: { font: { size: 10 } } }
        }
      }
    });
  }
}

// Budget Management
function initBudget() {
  document.getElementById('save-budget-btn').addEventListener('click', () => {
    const budgetAmount = Number(document.getElementById('monthly-budget-input').value);
    if (budgetAmount <= 0) {
      showNotification('Please enter a valid budget amount!', 'error');
      return;
    }

    FuelTrackerData.budget.monthly = budgetAmount;
    saveData();
    updateBudgetDisplay();
    showNotification(`Monthly budget set to ‚Çπ${budgetAmount.toLocaleString()}!`, 'success');
  });

  document.getElementById('reset-budget-btn').addEventListener('click', () => {
    if (confirm('Are you sure you want to reset your budget?')) {
      FuelTrackerData.budget.monthly = 0;
      document.getElementById('monthly-budget-input').value = '';
      saveData();
      updateBudgetDisplay();
      showNotification('Budget reset successfully!', 'info');
    }
  });

  document.getElementById('set-budget-btn').addEventListener('click', () => {
    document.getElementById('tab-budget').click();
  });
}

// FIXED: Reports with Real Data (not dummy data)
function renderReportsCharts() {
  console.log('Rendering reports with real data...');

  const expenses = getVehicleExpenses(FuelTrackerData.currentVehicle);

  // Destroy existing report charts if they exist
  Object.keys(dashboardCharts).forEach(chartKey => {
    if (chartKey.includes('Chart') && dashboardCharts[chartKey]) {
      dashboardCharts[chartKey].destroy();
      dashboardCharts[chartKey] = null;
    }
  });

  // 1. Monthly Spending Trends - REAL DATA
  const monthlyData = {};
  expenses.forEach(exp => {
    if (!exp.date) return;
    const month = exp.date.slice(0, 7);
    monthlyData[month] = (monthlyData[month] || 0) + exp.amount;
  });

  const months = Object.keys(monthlyData).sort();
  const monthlyAmounts = months.map(m => monthlyData[m]);

  const monthlyCtx = document.getElementById('monthlyChart');
  if (monthlyCtx) {
    dashboardCharts.monthlyChart = new Chart(monthlyCtx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: months.length ? months : ['No Data'],
        datasets: [{
          label: 'Monthly Spending',
          data: months.length ? monthlyAmounts : [0],
          backgroundColor: '#FFD600',
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        plugins: { 
          legend: { display: false },
          title: { display: true, text: 'Real Monthly Spending Data' }
        },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // 2. Fuel Efficiency Over Time - REAL DATA
  const efficiencyData = {};
  expenses.forEach(exp => {
    if (!exp.date || !exp.mileage) return;
    const month = exp.date.slice(0, 7);
    if (!efficiencyData[month]) efficiencyData[month] = [];
    efficiencyData[month].push(exp.mileage);
  });

  const efficiencyMonths = Object.keys(efficiencyData).sort();
  const avgEfficiency = efficiencyMonths.map(month => {
    const values = efficiencyData[month];
    return values.reduce((sum, val) => sum + val, 0) / values.length;
  });

  const efficiencyCtx = document.getElementById('efficiencyChart');
  if (efficiencyCtx) {
    dashboardCharts.efficiencyChart = new Chart(efficiencyCtx.getContext('2d'), {
      type: 'line',
      data: {
        labels: efficiencyMonths.length ? efficiencyMonths : ['No Data'],
        datasets: [{
          label: 'Fuel Efficiency',
          data: efficiencyMonths.length ? avgEfficiency : [0],
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        plugins: { 
          legend: { display: false },
          title: { display: true, text: 'Real Efficiency Data (km/L)' }
        },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // 3. Station Usage Analysis - REAL DATA
  const stationData = {};
  expenses.forEach(exp => {
    if (!exp.station) return;
    stationData[exp.station] = (stationData[exp.station] || 0) + 1;
  });

  const topStations = Object.entries(stationData)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 5);

  const stationCtx = document.getElementById('stationChart');
  if (stationCtx) {
    dashboardCharts.stationChart = new Chart(stationCtx.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: topStations.length ? topStations.map(([station]) => station) : ['No Station Data'],
        datasets: [{
          data: topStations.length ? topStations.map(([, count]) => count) : [1],
          backgroundColor: topStations.length ? 
            ['#FFD600', '#FFA000', '#FF8F00', '#FF6F00', '#E65100'] : 
            ['#e0e0e0']
        }]
      },
      options: {
        responsive: true,
        plugins: { 
          legend: { position: 'right' },
          title: { display: true, text: 'Real Station Usage Data' }
        }
      }
    });
  }

  // 4. Fuel Type Distribution - REAL DATA
  const fuelTypeData = {};
  expenses.forEach(exp => {
    const type = exp.fuelType || 'petrol';
    fuelTypeData[type] = (fuelTypeData[type] || 0) + 1;
  });

  const fuelTypeCtx = document.getElementById('fuelTypeChart');
  if (fuelTypeCtx) {
    dashboardCharts.fuelTypeChart = new Chart(fuelTypeCtx.getContext('2d'), {
      type: 'pie',
      data: {
        labels: Object.keys(fuelTypeData).length ? Object.keys(fuelTypeData) : ['No Data'],
        datasets: [{
          data: Object.keys(fuelTypeData).length ? Object.values(fuelTypeData) : [1],
          backgroundColor: Object.keys(fuelTypeData).length ? 
            ['#FFD600', '#3b82f6', '#f59e0b'] : 
            ['#e0e0e0']
        }]
      },
      options: {
        responsive: true,
        plugins: { 
          legend: { position: 'bottom' },
          title: { display: true, text: 'Real Fuel Type Usage' }
        }
      }
    });
  }

  // Show notification about real data
  if (expenses.length > 0) {
    showNotification(`Reports updated with ${expenses.length} real expense records!`, 'success');
  } else {
    showNotification('No expense data found for current vehicle. Add some expenses to see reports.', 'info');
  }
}

// Reports and Data Export
function initReports() {
  document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
  document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
  document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
  document.getElementById('export-data-btn').addEventListener('click', exportToJSON);
}

function exportToExcel() {
  try {
    const expenses = getVehicleExpenses(FuelTrackerData.currentVehicle);
    if (expenses.length === 0) {
      showNotification('No expenses to export!', 'warning');
      return;
    }

    const workbook = XLSX.utils.book_new();
    const wsData = expenses.map(exp => ({
      Date: exp.date,
      'Fuel Type': exp.fuelType,
      Amount: exp.amount,
      'Rate per Litre': exp.rate,
      Litres: exp.litres,
      'Fuel Cost': exp.fuelCost,
      Additives: exp.additives,
      'Start KM': exp.startKm,
      'End KM': exp.endKm,
      Mileage: exp.mileage,
      Station: exp.station,
      Vehicle: FuelTrackerData.vehicles.find(v => v.id === exp.vehicleId)?.name || 'Unknown'
    }));

    const worksheet = XLSX.utils.json_to_sheet(wsData);
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Expenses');
    XLSX.writeFile(workbook, `fuel-expenses-${new Date().toISOString().slice(0, 10)}.xlsx`);

    showNotification('Excel file exported successfully!', 'success');
  } catch (error) {
    console.error('Export error:', error);
    showNotification('Export failed. Please try again.', 'error');
  }
}

function exportToPDF() {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Header
    doc.setFontSize(20);
    doc.text('Fuel Expense Report', 20, 20);

    // Summary
    const expenses = getVehicleExpenses(FuelTrackerData.currentVehicle);
    const totalSpent = expenses.reduce((sum, exp) => sum + exp.amount, 0);
    const avgMileage = calculateAverageMileage(expenses);

    doc.setFontSize(12);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 35);
    doc.text(`Total Expenses: ${expenses.length}`, 20, 50);
    doc.text(`Total Amount: ‚Çπ${totalSpent.toLocaleString()}`, 20, 65);
    doc.text(`Average Mileage: ${avgMileage} km/L`, 20, 80);

    // Recent expenses
    doc.text('Recent Expenses:', 20, 100);
    const recent = expenses.slice(-10);
    let yPos = 110;

    recent.forEach(exp => {
      if (yPos > 270) {
        doc.addPage();
        yPos = 20;
      }
      doc.setFontSize(10);
      doc.text(`${exp.date} - ${exp.fuelType} - ‚Çπ${exp.amount} - ${exp.mileage || 'N/A'} km/L`, 20, yPos);
      yPos += 10;
    });

    doc.save(`fuel-report-${new Date().toISOString().slice(0, 10)}.pdf`);
    showNotification('PDF report generated successfully!', 'success');
  } catch (error) {
    console.error('PDF export error:', error);
    showNotification('PDF export failed. Please try again.', 'error');
  }
}

function exportToCSV() {
  const expenses = getVehicleExpenses(FuelTrackerData.currentVehicle);
  if (expenses.length === 0) {
    showNotification('No expenses to export!', 'warning');
    return;
  }

  const headers = ['Date', 'Fuel Type', 'Amount', 'Rate per Litre', 'Litres', 'Fuel Cost', 'Additives', 'Start KM', 'End KM', 'Mileage', 'Station'];
  const csvContent = [
    headers.join(','),
    ...expenses.map(exp => [
      exp.date,
      exp.fuelType,
      exp.amount,
      exp.rate,
      exp.litres,
      exp.fuelCost,
      exp.additives,
      exp.startKm,
      exp.endKm,
      exp.mileage,
      exp.station || ''
    ].join(','))
  ].join('\n');

  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `fuel-expenses-${new Date().toISOString().slice(0, 10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  showNotification('CSV file exported successfully!', 'success');
}

function exportToJSON() {
  const data = {
    expenses: FuelTrackerData.expenses,
    vehicles: FuelTrackerData.vehicles,
    budget: FuelTrackerData.budget,
    settings: FuelTrackerData.settings,
    exportDate: new Date().toISOString()
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `fueltracker-backup-${new Date().toISOString().slice(0, 10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  showNotification('Backup file created successfully!', 'success');
}

// Settings Management
function initSettings() {
  // Load current settings
  document.getElementById('price-alerts-setting').checked = FuelTrackerData.settings.priceAlerts;
  document.getElementById('budget-alerts-setting').checked = FuelTrackerData.settings.budgetAlerts;
  document.getElementById('maintenance-alerts-setting').checked = FuelTrackerData.settings.maintenanceAlerts;
  document.getElementById('currency-setting').value = FuelTrackerData.settings.currency;
  document.getElementById('date-format-setting').value = FuelTrackerData.settings.dateFormat;

  // Settings change handlers
  ['price-alerts-setting', 'budget-alerts-setting', 'maintenance-alerts-setting'].forEach(id => {
    document.getElementById(id).addEventListener('change', saveSettings);
  });

  ['currency-setting', 'date-format-setting'].forEach(id => {
    document.getElementById(id).addEventListener('change', saveSettings);
  });

  // Data management buttons
  document.getElementById('import-data-btn').addEventListener('click', () => {
    document.getElementById('import-file').click();
  });

  document.getElementById('import-file').addEventListener('change', importData);

  document.getElementById('backup-all-btn').addEventListener('click', () => {
    exportToJSON();
    showNotification('Full backup created!', 'success');
  });

  document.getElementById('clear-all-btn').addEventListener('click', () => {
    if (confirm('‚ö†Ô∏è This will DELETE ALL DATA. Are you absolutely sure?\n\nThis action cannot be undone!')) {
      if (confirm('Last warning: This will permanently delete all expenses, vehicles, and settings. Continue?')) {
        localStorage.clear();
        location.reload();
      }
    }
  });

  function saveSettings() {
    FuelTrackerData.settings.priceAlerts = document.getElementById('price-alerts-setting').checked;
    FuelTrackerData.settings.budgetAlerts = document.getElementById('budget-alerts-setting').checked;
    FuelTrackerData.settings.maintenanceAlerts = document.getElementById('maintenance-alerts-setting').checked;
    FuelTrackerData.settings.currency = document.getElementById('currency-setting').value;
    FuelTrackerData.settings.dateFormat = document.getElementById('date-format-setting').value;

    saveData();
    showNotification('Settings saved successfully!', 'success');
  }

  function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);

        if (confirm('This will replace all current data. Continue?')) {
          FuelTrackerData.expenses = data.expenses || [];
          FuelTrackerData.vehicles = data.vehicles || FuelTrackerData.vehicles;
          FuelTrackerData.budget = data.budget || FuelTrackerData.budget;
          FuelTrackerData.settings = data.settings || FuelTrackerData.settings;

          saveData();
          showNotification('Data imported successfully! Refreshing page...', 'success');
          setTimeout(() => location.reload(), 2000);
        }
      } catch (error) {
        showNotification('Invalid backup file format!', 'error');
      }
    };
    reader.readAsText(file);
  }
}

// Price Management
function initPrices() {
  document.getElementById('detect-location').addEventListener('click', () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        () => {
          showNotification('üìç Location detected: Chennai, Tamil Nadu', 'success');
          updateFuelPrices();
        },
        () => {
          showNotification('Could not detect location, using Chennai', 'warning');
          updateFuelPrices();
        }
      );
    } else {
      showNotification('Geolocation not supported', 'error');
    }
  });

  document.getElementById('refresh-prices').addEventListener('click', updateFuelPrices);

  document.getElementById('price-alerts').addEventListener('click', () => {
    const alertPrice = prompt('Set price alert for petrol (‚Çπ):', '95.00');
    if (alertPrice && !isNaN(alertPrice)) {
      showNotification(`Price alert set at ‚Çπ${alertPrice}`, 'success');
    }
  });

  // Update prices on load
  updateFuelPrices();
}

function updateFuelPrices() {
  const prices = fuelPrices[currentLocation];

  // Add small random variation
  const petrolPrice = prices.petrol + (Math.random() - 0.5) * 0.5;
  const dieselPrice = prices.diesel + (Math.random() - 0.5) * 0.5;
  const cngPrice = prices.cng + (Math.random() - 0.5) * 0.5;

  document.getElementById('petrol-price').textContent = `‚Çπ ${petrolPrice.toFixed(2)}`;
  document.getElementById('diesel-price').textContent = `‚Çπ ${dieselPrice.toFixed(2)}`;
  document.getElementById('cng-price').textContent = `‚Çπ ${cngPrice.toFixed(2)}`;

  document.getElementById('last-updated').textContent = 
    `Last updated: ${new Date().toLocaleTimeString()} - ${currentLocation}, Tamil Nadu`;
}

// Initialize Everything
document.addEventListener('DOMContentLoaded', () => {
  // Set today's date as default
  const today = new Date().toISOString().slice(0, 10);
  const dateInput = document.getElementById('date');
  if (dateInput) {
    dateInput.value = today;
  }

  console.log('Initializing FuelTracker Pro...');
  console.log('Current vehicle:', FuelTrackerData.currentVehicle);
  console.log('Total expenses:', FuelTrackerData.expenses.length);

  // Initialize all systems
  initNavigation();
  initVehicles();
  initExpenses();
  initBudget();
  initReports();
  initSettings();
  initPrices();

  // Initial dashboard update
  updateDashboard();
  renderExpensesTable();

  // Welcome message
  setTimeout(() => {
    showNotification('üéâ FuelTracker Pro Fixed Version Ready!', 'success', 4000);
  }, 1000);

  setTimeout(() => {
    showNotification('‚úÖ Vehicle switching and reports now work with real data!', 'info', 4000);
  }, 3000);
});
</script>
</body>
</html>
